# TCP Trace Events Documentation

This document explains the structure and meaning of TCP trace events generated by Inspector Gadget's `trace_tcp` gadget.

## Overview

TCP trace events are JSON objects that capture TCP connection lifecycle events (connect, accept, close) in Kubernetes pods. These events are generated using eBPF (Extended Berkeley Packet Filter) technology, which allows kernel-level monitoring without code changes.

## Event Structure

Each event has the following top-level structure:

```json
{
  "sessionId": "string",
  "timestamp": "ISO 8601 timestamp",
  "data": { ... },
  "eventType": "trace_tcp"
}
```

### Top-Level Fields

| Field | Type | Description |
|-------|------|-------------|
| `sessionId` | string | Unique identifier for the gadget session that generated this event |
| `timestamp` | string | ISO 8601 timestamp when the event was captured (e.g., "2025-11-18T10:30:45.123Z") |
| `data` | object | Contains the actual TCP trace event data (detailed below) |
| `eventType` | string | Type of gadget that generated the event (always "trace_tcp" for TCP traces) |

## Data Object Structure

The `data` object contains detailed information about the TCP event:

### Core TCP Event Fields

| Field | Type | Description |
|-------|------|-------------|
| `type` | string | Type of TCP event: `"connect"`, `"accept"`, or `"close"` |
| `fd` | number | File descriptor number used by the process for this connection |
| `accept_fd` | number | File descriptor for accepted connection (only for `accept` events) |
| `error` | number | Error code if the operation failed (0 = success, non-zero = error) |
| `netns_id` | number | Network namespace ID where the connection exists |

### Event Types

- **`connect`**: Outbound connection initiated by the pod
- **`accept`**: Inbound connection accepted by the pod (server-side)
- **`close`**: Connection closed by either side

### Source Endpoint (`src`)

Describes the source (client) side of the connection:

```json
{
  "addr": "10.42.0.15",
  "port": 45678,
  "proto": 6,
  "k8s": {
    "kind": "pod",
    "name": "apples-deployment-xyz",
    "namespace": "demo"
  }
}
```

| Field | Description |
|-------|-------------|
| `addr` | Source IP address |
| `port` | Source port number |
| `proto` | IP protocol number (6 = TCP, 17 = UDP) |
| `k8s.kind` | Kubernetes resource type: `"pod"`, `"svc"` (service), or `"raw"` (external) |
| `k8s.name` | Name of the Kubernetes resource |
| `k8s.namespace` | Kubernetes namespace |

### Destination Endpoint (`dst`)

Describes the destination (server) side of the connection:

```json
{
  "addr": "10.43.0.100",
  "port": 8080,
  "proto": 6,
  "k8s": {
    "kind": "svc",
    "name": "oranges-service",
    "namespace": "demo"
  }
}
```

Same structure as `src`. The `kind` field indicates:
- `"pod"`: Direct pod-to-pod communication
- `"svc"`: Communication to a Kubernetes Service
- `"raw"`: External IP outside the cluster

### Kubernetes Context (`k8s`)

Metadata about the Kubernetes pod generating the event:

```json
{
  "node": "k3s-node-1",
  "namespace": "demo",
  "podName": "apples-deployment-7d9f8b-xyz",
  "containerName": "apples",
  "podLabels": {
    "app": "apples",
    "pod-template-hash": "7d9f8b"
  },
  "owner": {
    "kind": "ReplicaSet",
    "name": "apples-deployment-7d9f8b",
    "apiVersion": "apps/v1"
  }
}
```

| Field | Description |
|-------|-------------|
| `node` | Kubernetes node where the pod is running |
| `namespace` | Namespace containing the pod |
| `podName` | Name of the pod |
| `containerName` | Name of the container within the pod |
| `podLabels` | Key-value labels attached to the pod |
| `owner.kind` | Type of controller managing the pod (Deployment, ReplicaSet, StatefulSet, etc.) |
| `owner.name` | Name of the owning controller |
| `owner.apiVersion` | Kubernetes API version of the owner |

### Process Information (`proc`)

Details about the process that initiated the TCP operation:

```json
{
  "comm": "python3",
  "pid": 12345,
  "tid": 12345,
  "parent": {
    "comm": "bash",
    "pid": 1234
  },
  "creds": {
    "uid": 1000,
    "gid": 1000
  }
}
```

| Field | Description |
|-------|-------------|
| `comm` | Command name (process executable name, max 16 chars) |
| `pid` | Process ID |
| `tid` | Thread ID (usually same as PID for single-threaded processes) |
| `parent.comm` | Parent process command name |
| `parent.pid` | Parent process ID |
| `creds.uid` | User ID running the process |
| `creds.gid` | Group ID running the process |

### Runtime Information (`runtime`)

Container runtime details:

```json
{
  "runtimeName": "containerd",
  "containerId": "a1b2c3d4e5f6...",
  "containerImageName": "docker.io/library/python:3.9-slim",
  "containerPid": 67890
}
```

| Field | Description |
|-------|-------------|
| `runtimeName` | Container runtime (e.g., "containerd", "cri-o", "docker") |
| `containerId` | Full container ID (SHA256 hash) |
| `containerImageName` | Full container image name including registry |
| `containerPid` | Process ID as seen from the container's perspective (may differ from host PID) |

## Example Events

### Connect Event (Outbound Connection)

```json
{
  "sessionId": "abc123",
  "timestamp": "2025-11-18T10:30:45.123Z",
  "data": {
    "type": "connect",
    "fd": 3,
    "error": 0,
    "src": {
      "addr": "10.42.0.15",
      "port": 45678,
      "proto": 6,
      "k8s": {
        "kind": "pod",
        "name": "apples-deployment-xyz",
        "namespace": "demo"
      }
    },
    "dst": {
      "addr": "10.43.0.100",
      "port": 8080,
      "proto": 6,
      "k8s": {
        "kind": "svc",
        "name": "oranges-service",
        "namespace": "demo"
      }
    },
    "k8s": {
      "node": "k3s-node-1",
      "namespace": "demo",
      "podName": "apples-deployment-7d9f8b-xyz",
      "containerName": "apples"
    },
    "proc": {
      "comm": "python3",
      "pid": 12345,
      "tid": 12345
    }
  },
  "eventType": "trace_tcp"
}
```

**Interpretation**: The Python process in the `apples` pod initiated a TCP connection to the `oranges-service` on port 8080. The connection was successful (error = 0).

### Accept Event (Inbound Connection)

```json
{
  "sessionId": "abc123",
  "timestamp": "2025-11-18T10:30:45.124Z",
  "data": {
    "type": "accept",
    "fd": 4,
    "accept_fd": 5,
    "error": 0,
    "src": {
      "addr": "10.42.0.15",
      "port": 45678,
      "proto": 6,
      "k8s": {
        "kind": "pod",
        "name": "apples-deployment-xyz",
        "namespace": "demo"
      }
    },
    "dst": {
      "addr": "10.42.0.20",
      "port": 8080,
      "proto": 6,
      "k8s": {
        "kind": "pod",
        "name": "oranges-deployment-abc",
        "namespace": "demo"
      }
    },
    "k8s": {
      "node": "k3s-node-1",
      "namespace": "demo",
      "podName": "oranges-deployment-abc",
      "containerName": "oranges"
    },
    "proc": {
      "comm": "flask",
      "pid": 23456,
      "tid": 23456
    }
  },
  "eventType": "trace_tcp"
}
```

**Interpretation**: The Flask process in the `oranges` pod accepted an incoming TCP connection from the `apples` pod. A new file descriptor (5) was created for the accepted connection.

### Close Event

```json
{
  "sessionId": "abc123",
  "timestamp": "2025-11-18T10:30:50.500Z",
  "data": {
    "type": "close",
    "fd": 5,
    "error": 0,
    "src": {
      "addr": "10.42.0.20",
      "port": 8080,
      "proto": 6,
      "k8s": {
        "kind": "pod",
        "name": "oranges-deployment-abc",
        "namespace": "demo"
      }
    },
    "dst": {
      "addr": "10.42.0.15",
      "port": 45678,
      "proto": 6,
      "k8s": {
        "kind": "pod",
        "name": "apples-deployment-xyz",
        "namespace": "demo"
      }
    },
    "k8s": {
      "node": "k3s-node-1",
      "namespace": "demo",
      "podName": "oranges-deployment-abc",
      "containerName": "oranges"
    },
    "proc": {
      "comm": "flask",
      "pid": 23456,
      "tid": 23456
    }
  },
  "eventType": "trace_tcp"
}
```

**Interpretation**: The connection was closed. File descriptor 5 was released. The `src` and `dst` show the endpoints of the now-closed connection.

### External Connection (Raw Kind)

```json
{
  "data": {
    "type": "connect",
    "src": {
      "addr": "10.42.0.15",
      "port": 45678,
      "k8s": {
        "kind": "pod",
        "name": "apples-deployment-xyz",
        "namespace": "demo"
      }
    },
    "dst": {
      "addr": "8.8.8.8",
      "port": 53,
      "k8s": {
        "kind": "raw"
      }
    }
  }
}
```

**Interpretation**: The pod is connecting to an external IP address (8.8.8.8) outside the Kubernetes cluster. The `kind: "raw"` indicates this is not a Kubernetes resource.

## How the Flow Diagram Uses These Events

The TCP Flow Diagram visualization uses these fields to create a network topology:

1. **Nodes**: Created from `src.k8s.name` and `dst.k8s.name` (or IP addresses if no k8s name)
2. **Node Types** (colors):
   - Blue circle: Kubernetes Service (`kind: "svc"`)
   - Green circle: Pod (`kind: "pod"`)
   - Orange circle: External IP (`kind: "raw"`)
3. **Connections**: Arrows drawn from source to destination
4. **Labels**: Format varies by type:
   - Services: `name.namespace.svc:port`
   - Pods: `name.namespace.pod:port`
   - External: `ip:port`

## Filtering Options

The trace_tcp gadget supports the following flags:

- `--accept-only`: Only show accept events (inbound connections)
- `--connect-only`: Only show connect events (outbound connections)
- `--failure-only`: Only show failed connections (error â‰  0)

## Common Use Cases

1. **Service Mesh Discovery**: Identify which services communicate with each other
2. **Security Auditing**: Detect unexpected external connections
3. **Performance Debugging**: Find connection failures and their sources
4. **Network Policy Testing**: Verify that network policies are working as intended
5. **Troubleshooting**: Identify which pods are unable to connect to services

## Error Codes

The `error` field uses standard Linux errno values:

| Code | Name | Description |
|------|------|-------------|
| 0 | SUCCESS | Operation completed successfully |
| 110 | ETIMEDOUT | Connection timed out |
| 111 | ECONNREFUSED | Connection refused by remote host |
| 113 | EHOSTUNREACH | No route to host |
| 104 | ECONNRESET | Connection reset by peer |

For a complete list, see `errno(3)` or `/usr/include/asm-generic/errno.h`.

## Technical Details

### eBPF Collection

These events are collected using eBPF (Extended Berkeley Packet Filter) programs attached to kernel tracepoints and kprobes:

- `connect` events: Captured from `tcp_v4_connect` and `tcp_v6_connect` kernel functions
- `accept` events: Captured from `inet_csk_accept` kernel function
- `close` events: Captured from TCP socket close operations

The eBPF programs run in kernel space and have minimal performance impact on the monitored workloads.

### Enrichment Process

Inspector Gadget enriches raw kernel events with Kubernetes metadata by:

1. Reading container metadata from cgroups
2. Querying the Kubernetes API for pod information
3. Resolving IP addresses to service names using cluster DNS
4. Matching processes to their container contexts

This enrichment happens in real-time as events are generated.
